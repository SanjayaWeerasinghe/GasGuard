<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>GasGuard | High-Fidelity Digital Twin</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        :root {
            --neon-blue: #00d4ff; --neon-green: #4ade80; --neon-red: #fb7185;
            --panel-bg: rgba(7, 15, 30, 0.9); --border: 1px solid rgba(0, 212, 255, 0.3);
        }
        body { margin: 0; background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }

        /* TACTICAL HUD */
        #hud { position: absolute; inset: 0; pointer-events: none; z-index: 10; padding: 25px; display: flex; flex-direction: column; justify-content: space-between; }
        .glass { background: var(--panel-bg); border: var(--border); backdrop-filter: blur(12px); padding: 18px; border-radius: 4px; pointer-events: auto; }
        .sidebar { width: 320px; display: flex; flex-direction: column; gap: 15px; }
        
        .big-val { font-size: 38px; font-weight: bold; font-family: 'Courier New', monospace; margin: 5px 0; }
        .label { font-size: 10px; text-transform: uppercase; color: var(--neon-blue); letter-spacing: 2px; }

        .zone-info-card { border-left: 4px solid var(--neon-blue); }
        .alert-active { border-color: var(--neon-red) !important; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 50% { box-shadow: 0 0 25px var(--neon-red); } }

        .btn { background: rgba(0,0,0,0.6); border: var(--border); color: #fff; padding: 10px 20px; cursor: pointer; font-size: 11px; text-transform: uppercase; pointer-events: auto; }
        .btn:hover { background: var(--neon-blue); color: #000; }
        
        #instructions { position: absolute; bottom: 20px; right: 20px; font-size: 11px; color: var(--neon-blue); opacity: 0.7; }
    </style>
</head>
<body>

    <div id="hud">
        <div class="sidebar">
            <div id="status-card" class="glass zone-info-card">
                <div class="label" id="current-zone-id">Facility Overview</div>
                <div id="zone-description" style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">SELECT A ZONE TO INSPECT</div>
                <div class="big-val" id="ppm-display">--- <span style="font-size:14px; opacity:0.5;">PPM</span></div>
                <div id="status-txt" style="color:var(--neon-green); font-size: 12px; font-weight: 600;">SYSTEM READY</div>
            </div>

            <div class="glass" id="sensor-health-card">
                <div class="label">Hardware Topology</div>
                <div id="hardware-list" style="margin-top:10px; font-size: 12px; line-height: 1.6;">
                    • Gateway: ESP32 Edge Console<br>
                    • Network: MQTT v3.1.1<br>
                    • Nodes: 4 Zone Clusters
                </div>
            </div>
        </div>

        <div style="align-self: center; display: flex; gap: 10px;">
            <button class="btn" onclick="resetView()">Global View</button>
            <button class="btn" onclick="window.history.back()">Exit Dashboard</button>
        </div>
    </div>

    <div id="instructions">CLICK ZONES TO DEEP DIVE • SCROLL TO ZOOM</div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- CONFIG & CONSTANTS ---
        const params = new URLSearchParams(window.location.search);
        const INITIAL_PPM = Number(params.get("ppm")) || 120;
        const INITIAL_ZONE = params.get("zone") || "GLOBAL";

       const ZONE_DATA = {
    A: { name: "Storage (LPG)", gas: "LPG", sensors: "MQ-2", pos: [-6, 4], color: 0x4ade80, height: "Floor (Heavy)" },
    B: { name: "Compression (Methane)", gas: "CH4", sensors: "MQ-4", pos: [6, 4], color: 0x38bdf8, height: "Ceiling (Light)" },
    C: { name: "Refinery (CO)", gas: "CO", sensors: "MQ-7", pos: [-6, -4], color: 0xfb7185, height: "Mid (Diffuse)" },
    D: { name: "Utility (H2S)", gas: "H2S", sensors: "MQ-136", pos: [6, -4], color: 0xa855f7, height: "Drain (Very Heavy)" }
};


        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x01050a);
        scene.fog = new THREE.FogExp2(0x01050a, 0.03);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(25, 20, 25);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.0, 0.4, 0.85));

        // --- LIGHTING ---
        scene.add(new THREE.AmbientLight(0xffffff, 0.2));
        const dirLight = new THREE.DirectionalLight(0x00d4ff, 1);
        dirLight.position.set(10, 20, 10);
        scene.add(dirLight);

        // --- FACILITY BUILDING ---
        const floorGeo = new THREE.PlaneGeometry(24, 16);
        const floorMat = new THREE.MeshStandardMaterial({ color: 0x050a14, roughness: 0.8 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        const grid = new THREE.GridHelper(24, 24, 0x00d4ff, 0x021626);
        grid.position.y = 0.01;
        scene.add(grid);

        // --- ASSET CREATION FUNCTIONS ---
        function createCylinder(x, z, h=1.5, color=0x2c3e50) {
            const geo = new THREE.CylinderGeometry(0.3, 0.3, h, 12);
            const mat = new THREE.MeshStandardMaterial({ color });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(x, h/2, z);
            scene.add(mesh);
        }

        function createEngine(x, z) {
            const group = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(2, 1.5, 3), new THREE.MeshStandardMaterial({color: 0x1a2a3a}));
            body.position.y = 0.75;
            group.add(body);
            const pipe = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 4), new THREE.MeshStandardMaterial({color: 0x0a1a2a}));
            pipe.position.set(0, 2, 0);
            group.add(pipe);
            group.position.set(x, 0, z);
            scene.add(group);
        }

        function createPipeline(x, z, length, rot=0) {
            const geo = new THREE.CylinderGeometry(0.15, 0.15, length, 12);
            const mat = new THREE.MeshStandardMaterial({ color: 0x334455 });
            const pipe = new THREE.Mesh(geo, mat);
            pipe.position.set(x, 2, z);
            pipe.rotation.z = Math.PI/2;
            pipe.rotation.y = rot;
            scene.add(pipe);
        }

        function createFan(x, y, z, rotY=0) {
            const group = new THREE.Group();
            const frame = new THREE.Mesh(new THREE.TorusGeometry(0.5, 0.05, 8, 24), new THREE.MeshBasicMaterial({color: 0x00d4ff}));
            const blade = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.1, 0.05), new THREE.MeshBasicMaterial({color: 0x00d4ff}));
            group.add(frame, blade);
            group.position.set(x, y, z);
            group.rotation.y = rotY;
            scene.add(group);
            return blade;
        }

        // --- BUILD THE FACILITY ---
        // Zone A Assets
        createCylinder(-8, 6, 2); createCylinder(-9, 6, 2);
        const fanA = createFan(-12, 1.5, 6, Math.PI/2);
        
        // Zone B Assets
        createPipeline(6, 7.8, 12);
        const fanB = createFan(6, 4.2, 8, 0);

        // Zone C Assets
        createEngine(-8, -5);
        const fanC = createFan(-12, 1.5, -5, Math.PI/2);

        // Zone D Assets
        const drain = new THREE.Mesh(new THREE.BoxGeometry(8, 0.1, 1), new THREE.MeshStandardMaterial({color: 0x000000}));
        drain.position.set(6, 0.05, -6);
        scene.add(drain);
        const fanD = createFan(10, 0.6, -8, 0);

        // Central Edge Gateway Node
        const gateway = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.8, 0.2), new THREE.MeshBasicMaterial({color: 0x00d4ff}));
        gateway.position.set(-11.9, 2, 0);
        scene.add(gateway);

        // --- GAS PARTICLE SYSTEMS ---
        const particleSystems = {};
        const particleOriginY = { A: 0.5, B: 3.5, C: 1.5, D: 0.2 };

        function createGasSystem(id) {
            const data = ZONE_DATA[id];
            const count = 2000;
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(count * 3);
            const vels = [];
            
            for(let i=0; i<count; i++) {
                pos[i*3] = data.pos[0];
                pos[i*3+1] = particleOriginY[id];
                pos[i*3+2] = data.pos[1];
                vels.push((Math.random()-0.5)*0.1, Math.random()*0.1, (Math.random()-0.5)*0.1);
            }
            
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            const mat = new THREE.PointsMaterial({ 
                size: 0.15, 
                color: data.color, 
                transparent: true, 
                opacity: 0.5, 
                blending: THREE.AdditiveBlending 
            });
            const points = new THREE.Points(geo, mat);
            scene.add(points);
            return { points, vels, pos, id };
        }

        ['A', 'B', 'C', 'D'].forEach(id => particleSystems[id] = createGasSystem(id));

        // --- INTERACTIVITY (RAYCASTING) ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('mousedown', (event) => {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            // Simple invisible bounding boxes for zones
            const zoneIntersects = {
                A: [-12, 0, 0, 8],
                B: [0, 12, 0, 8],
                C: [-12, 0, -8, 0],
                D: [0, 12, -8, 0]
            };

            for (const [id, bounds] of Object.entries(zoneIntersects)) {
                const intersect = raycaster.intersectObject(floor);
                if (intersect.length > 0) {
                    const p = intersect[0].point;
                    if (p.x >= bounds[0] && p.x <= bounds[1] && p.z >= bounds[2] && p.z <= bounds[3]) {
                        focusZone(id);
                        return;
                    }
                }
            }
        });

        function focusZone(id) {
            const data = ZONE_DATA[id];
            const targetPos = new THREE.Vector3(data.pos[0], 0, data.pos[1]);
            
            // Camera Animation
            new Promise(resolve => {
                const startPos = camera.position.clone();
                const endPos = new THREE.Vector3(data.pos[0] + 8, 6, data.pos[1] + 8);
                let t = 0;
                const anim = () => {
                    t += 0.05;
                    camera.position.lerpVectors(startPos, endPos, t);
                    controls.target.lerp(targetPos, t);
                    if(t < 1) requestAnimationFrame(anim);
                };
                anim();
            });

            // Update UI
            document.getElementById('current-zone-id').innerText = `ZONE ${id} INTERFACE`;
            document.getElementById('zone-description').innerText = data.name;
            document.getElementById('ppm-display').innerHTML = `${INITIAL_PPM} <span style="font-size:14px; opacity:0.5;">PPM</span>`;
            document.getElementById('hardware-list').innerHTML = `
                • Primary Sensor: ${data.sensors.split(',')[0]}<br>
                • Env Logic: ${data.sensors.split(',').slice(1).join(', ')}<br>
                • Drift Height: ${data.height}<br>
                • Fan Status: <span style="color:var(--neon-green)">ACTIVE</span>
            `;
            
            if(INITIAL_PPM > 400) {
                document.getElementById('status-card').classList.add('alert-active');
                document.getElementById('status-txt').innerText = "EMERGENCY VENTILATION ON";
                document.getElementById('status-txt').style.color = "var(--neon-red)";
            }
        }

        window.resetView = () => {
            controls.target.set(0, 0, 0);
            camera.position.set(25, 20, 25);
            document.getElementById('current-zone-id').innerText = "Facility Overview";
            document.getElementById('zone-description').innerText = "SELECT A ZONE TO INSPECT";
            document.getElementById('ppm-display').innerText = "--- PPM";
            document.getElementById('status-card').classList.remove('alert-active');
            document.getElementById('status-txt').innerText = "SYSTEM READY";
            document.getElementById('status-txt').style.color = "var(--neon-green)";
        };

        // --- ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            // Rotate Fans
            fanA.rotation.z += 0.2;
            fanB.rotation.z += 0.2;
            fanC.rotation.z += 0.2;
            fanD.rotation.z += 0.2;

            // Animate Gas
            Object.values(particleSystems).forEach(sys => {
                const pos = sys.points.geometry.attributes.position.array;
                const origin = ZONE_DATA[sys.id].pos;
                const startY = particleOriginY[sys.id];

                for(let i=0; i<sys.vels.length; i++) {
                    pos[i*3] += sys.vels[i].x;
                    pos[i*3+1] += sys.vels[i].y;
                    pos[i*3+2] += sys.vels[i].z;

                    // Reset logic varies by gas weight
                    if(sys.id === 'B') { // Methane rises
                        if(pos[i*3+1] > 4.5) { pos[i*3]=origin[0]; pos[i*3+1]=startY; pos[i*3+2]=origin[1]; }
                    } else { // Others sink or reset
                        if(pos[i*3+1] > 3) { pos[i*3]=origin[0]; pos[i*3+1]=startY; pos[i*3+2]=origin[1]; }
                    }
                }
                sys.points.geometry.attributes.position.needsUpdate = true;
            });

            composer.render();
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });

        // Auto-run focus if zone passed in URL
        if(INITIAL_ZONE !== "GLOBAL" && ZONE_DATA[INITIAL_ZONE]) {
            setTimeout(() => focusZone(INITIAL_ZONE), 500);
        }
    </script>
</body>
</html>